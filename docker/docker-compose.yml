version: '3.8'

services:
  control:
    build:
      context: ..
      dockerfile: docker/control/Dockerfile
    container_name: kakuremichi-control
    ports:
      - "3000:3000"
      - "3001:3001"  # WebSocket port
    environment:
      - NODE_ENV=development
      - DATABASE_URL=/app/data/kakuremichi.db
      - PORT=3000
      - WS_PORT=3001
      - PUBLIC_URL=http://localhost:3000
      - SESSION_SECRET=dev-secret-change-in-production
    volumes:
      - control-data:/app/data
    networks:
      - kakuremichi

  gateway:
    build:
      context: ..
      dockerfile: docker/gateway/Dockerfile
    container_name: kakuremichi-gateway
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun
    ports:
      - "51820:51820/udp"  # WireGuard
      - "80:80"            # HTTP
      - "443:443"          # HTTPS
    environment:
      - CONTROL_URL=ws://control:3001
      - API_KEY=gtw_dev_key_replace_in_production
      - WIREGUARD_PORT=51820
      - HTTP_PORT=80
      - HTTPS_PORT=443
      - ACME_EMAIL=admin@example.com
      - ACME_STAGING=true
      - PUBLIC_IP=auto
      - REGION=dev
    volumes:
      - gateway-cache:/root/cache
    networks:
      - kakuremichi
    depends_on:
      - control

  agent:
    build:
      context: ..
      dockerfile: docker/agent/Dockerfile
    container_name: kakuremichi-agent
    environment:
      - CONTROL_URL=ws://control:3001
      - API_KEY=agt_dev_key_replace_in_production
      - DOCKER_ENABLED=false
    networks:
      - kakuremichi
    depends_on:
      - control
      - gateway

volumes:
  control-data:
  gateway-cache:

networks:
  kakuremichi:
    driver: bridge
